# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#

import "Pipelines/TestsFastfile"
import "Pipelines/DeployFastfile"

default_platform(:ios)

platform :ios do

    desc "Run tests"
    lane :test do
        slack_start_build
    	run_tests_pipeline
    end

	desc "Deploy a new version"
    lane :release do
        slack_start_build
        run_deploy_pipeline
    end

    desc "Send message to slack that indicates the process has been started"
    lane :slack_start_build do
        slack(
            channel: "#fastlane",
            slack_url: ENV["SLACK_WEBHOOK"],
            attachment_properties: {
                fields: [
                    {
                        title: "Project",
                        value: "Emerald",
                        short: true
                    },
                    {
                        title: "Pipeline",
                        value: "Test",
                        short: true
                    }
                ],
                actions: [
                    {
                        type: "button",
                        text: "View Build",
                        url: ENV["BITRISE_BUILD_URL"]
                    }
                ],
                footer: "Bitrise",
                footer_icon: "https://github.com/bitrise-io.png"
            }
        )
    end

end
